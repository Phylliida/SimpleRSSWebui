<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simple RSS Feeds</title>
  <style>
    :root {
      --bg: #0f172a;
      --fg: #e2e8f0;
      --card: #1e293b;
      --accent: #7dd3fc;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Palatino", "Book Antiqua", serif;
      background: radial-gradient(circle at 20% 20%, rgba(125, 211, 252, 0.12), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(248, 113, 113, 0.14), transparent 30%),
                  var(--bg);
      color: var(--fg);
      display: grid;
      place-items: center;
      padding: 2rem;
    }
    .card {
      width: min(720px, 100%);
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      box-shadow: 0 16px 60px rgba(0, 0, 0, 0.35);
      padding: 24px 26px;
    }
    h1 {
      margin: 0 0 8px;
      letter-spacing: 0.02em;
      font-size: 28px;
    }
    p {
      margin: 0 0 16px;
      color: #cbd5e1;
    }
    form {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    input[type="url"] {
      flex: 1 1 260px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(15, 23, 42, 0.8);
      color: var(--fg);
      outline: none;
    }
    input[type="url"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(125, 211, 252, 0.3);
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), #38bdf8);
      color: #0f172a;
      font-weight: 700;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    a {
      color: var(--accent);
      text-decoration: none;
    }
    a:hover { text-decoration: underline; }
    .list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 8px;
    }
    .list li {
      padding: 10px 12px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.07);
      word-break: break-word;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .list li.viewed {
      opacity: 0.75;
    }
    #items li {
      align-items: flex-start;
      flex-direction: column;
      gap: 6px;
    }
    .item-head {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      width: 100%;
    }
    .item-main {
      flex: 1 1 auto;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .item-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
    }
    .item-title {
      font-weight: 700;
      line-height: 1.3;
    }
    .meta {
      color: #cbd5e1;
      font-size: 14px;
    }
    .summary {
      color: #e2e8f0;
      font-size: 15px;
      line-height: 1.5;
      white-space: pre-line;
    }
    .thumb-wrap {
      flex: 0 0 auto;
    }
    .thumb {
      width: 120px;
      height: auto;
      border-radius: 8px;
      object-fit: cover;
      display: block;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }
    .summary img {
      max-width: 100%;
      max-height: 320px;
      height: auto;
      width: auto;
      object-fit: contain;
      display: block;
      margin: 6px 0;
      border-radius: 8px;
    }
    .delete {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: #0f172a;
      color: #fca5a5;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      transition: background 120ms ease, transform 120ms ease;
    }
    .delete:hover { background: #1e293b; transform: translateY(-1px); }
    .mark {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(125, 211, 252, 0.3);
      background: rgba(125, 211, 252, 0.08);
      color: #7dd3fc;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: transform 120ms ease, border-color 120ms ease;
    }
    .mark:hover { transform: translateY(-1px); border-color: rgba(125, 211, 252, 0.6); }
    .mark:disabled { opacity: 0.6; cursor: default; transform: none; }
    .mark-box {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #bae6fd;
      font-size: 13px;
      user-select: none;
    }
    .mark-toggle {
      border: 1px solid rgba(125, 211, 252, 0.25);
      background: rgba(125, 211, 252, 0.08);
      border-radius: 10px;
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #7dd3fc;
      cursor: pointer;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
      overflow: visible;
    }
    .mark-toggle:hover { transform: translateY(-1px); border-color: rgba(125, 211, 252, 0.5); }
    .mark-toggle:active { transform: translateY(0); }
    .mark-toggle.viewed { color: #cbd5e1; background: rgba(148, 163, 184, 0.08); border-color: rgba(148, 163, 184, 0.3); }
    .mark-icon {
      width: 22px;
      height: 22px;
      display: block;
      transform: scale(4);
      transform-origin: center;
    }
    .pager {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 12px;
      font-size: 14px;
      color: #cbd5e1;
    }
    .pager button {
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 700;
      background: rgba(125, 211, 252, 0.12);
      color: #e2e8f0;
      border: 1px solid rgba(125, 211, 252, 0.25);
    }
    .pager button:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
    }
    .items-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin: 18px 0 8px;
    }
    .items-header h2 {
      margin: 0;
    }
    .status {
      min-height: 20px;
      color: #a5f3fc;
      font-size: 14px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
    <div class="card">
      <h1>RSS Sources</h1>
      <p>Append new feeds to the log; the API exposes a simple list for feedparser/reader.</p>
      <form id="feed-form">
        <input id="feed-url" type="url" name="url" placeholder="https://example.com/feed.xml" required />
        <button type="submit">Add feed</button>
      </form>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;">
        <label style="display:flex;align-items:center;gap:8px;font-size:14px;color:#cbd5e1;">
          <input id="opml-file" type="file" accept=".opml, text/xml" style="color:#cbd5e1;" />
        </label>
        <button type="button" id="import-opml">Import OPML</button>
        <button type="button" id="export-opml">Export OPML</button>
        <button type="button" id="refresh-feeds">Refresh feeds</button>
      </div>
      <label for="item-limit" style="display:flex;align-items:center;gap:8px;margin-bottom:10px;font-size:14px;color:#cbd5e1;">
        Items to show (0 = all):
        <input id="item-limit" type="number" min="0" value="50" style="width:90px;padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(15,23,42,0.8);color:var(--fg);" />
      </label>
      <label for="show-viewed" style="display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:14px;color:#cbd5e1;">
        <input id="show-viewed" type="checkbox" />
        Show viewed items
      </label>
      <div class="status" id="status"></div>
      <ul id="feeds" class="list"></ul>
      <div class="items-header">
        <h2>Items</h2>
        <div class="pager pager-inline" style="display:none;">
          <button class="prev-page" type="button">Previous</button>
          <div class="page-info">Page 1</div>
          <button class="next-page" type="button">Next</button>
        </div>
      </div>
      <ul id="items" class="list"></ul>
      <div class="pager pager-bottom" style="display:none;">
        <button class="prev-page" type="button">Previous</button>
        <div class="page-info">Page 1</div>
        <button class="next-page" type="button">Next</button>
      </div>
    </div>
  <script>
    const feedList = document.getElementById("feeds");
    const itemsList = document.getElementById("items");
    const statusBox = document.getElementById("status");
    const urlInput = document.getElementById("feed-url");
    const opmlInput = document.getElementById("opml-file");
    const importOpmlBtn = document.getElementById("import-opml");
    const exportOpmlBtn = document.getElementById("export-opml");
    const refreshBtn = document.getElementById("refresh-feeds");
    const itemLimitInput = document.getElementById("item-limit");
    const showViewedInput = document.getElementById("show-viewed");
    const pagers = Array.from(document.querySelectorAll(".pager"));
    const pageInfos = Array.from(document.querySelectorAll(".page-info"));
    const prevPageBtns = Array.from(document.querySelectorAll(".prev-page"));
    const nextPageBtns = Array.from(document.querySelectorAll(".next-page"));
    let currentPage = 1;
    let totalItems = 0;
    const viewedIcon = `<svg class="mark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M1.606 6.08a1 1 0 0 1 1.313.526L2 7l.92-.394v-.001l.003.009l.021.045l.094.194c.086.172.219.424.4.729a13.4 13.4 0 0 0 1.67 2.237a12 12 0 0 0 .59.592C7.18 11.8 9.251 13 12 13a8.7 8.7 0 0 0 3.22-.602c1.227-.483 2.254-1.21 3.096-1.998a13 13 0 0 0 2.733-3.725l.027-.058l.005-.011a1 1 0 0 1 1.838.788L22 7l.92.394l-.003.005l-.004.008l-.011.026l-.04.087a14 14 0 0 1-.741 1.348a15.4 15.4 0 0 1-1.711 2.256l.797.797a1 1 0 0 1-1.414 1.415l-.84-.84a12 12 0 0 1-1.897 1.256l.782 1.202a1 1 0 1 1-1.676 1.091l-.986-1.514c-.679.208-1.404.355-2.176.424V16.5a1 1 0 0 1-2 0v-1.544c-.775-.07-1.5-.217-2.177-.425l-.985 1.514a1 1 0 0 1-1.676-1.09l.782-1.203c-.7-.37-1.332-.8-1.897-1.257l-.84.84a1 1 0 0 1-1.414-1.414l.797-.797a15.4 15.4 0 0 1-1.87-2.519a14 14 0 0 1-.591-1.107l-.033-.072l-.01-.021l-.002-.007l-.001-.002v-.001C1.08 7.395 1.08 7.394 2 7l-.919.395a1 1 0 0 1 .525-1.314" clip-rule="evenodd"/></svg>`;
    const unviewedIcon = `<svg class="mark-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3.275 15.296C2.425 14.192 2 13.639 2 12c0-1.64.425-2.191 1.275-3.296C4.972 6.5 7.818 4 12 4s7.028 2.5 8.725 4.704C21.575 9.81 22 10.361 22 12c0 1.64-.425 2.191-1.275 3.296C19.028 17.5 16.182 20 12 20s-7.028-2.5-8.725-4.704Z"/><path d="M15 12a3 3 0 1 1-6 0a3 3 0 0 1 6 0Z"/></g></svg>`;

    const renderFeeds = (feeds) => {
      feedList.innerHTML = feeds.map(
        (url) => `<li><span>${url}</span><button class="delete" data-url="${url}" aria-label="Remove ${url}">&minus;</button></li>`
      ).join("");
    };

    const esc = (text = "") =>
      text.replace(/[&<>"']/g, (ch) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[ch]));
    const safeUrl = (url = "") =>
      (typeof url === "string" && (url.startsWith("http://") || url.startsWith("https://"))) ? url : "";

    const formatTime = (value) => {
      if (!value) return "";
      const parsed = new Date(value);
      return Number.isNaN(parsed.getTime())
        ? value
        : parsed.toLocaleString(undefined, { dateStyle: "medium", timeStyle: "short" });
    };

    const sanitizeSummary = (html = "") => {
      const allowed = new Set(["a", "p", "br", "strong", "em", "b", "i", "u", "ul", "ol", "li", "pre", "code", "span", "div", "img"]);
      const attrAllow = { a: ["href", "title"], img: ["src", "alt", "title"] };
      const safeUrl = (url = "") => (url.startsWith("http://") || url.startsWith("https://")) ? url : "";
      const doc = new DOMParser().parseFromString(html, "text/html");
      const clean = (node) => {
        if (node.nodeType === Node.TEXT_NODE) return document.createTextNode(node.textContent || "");
        if (node.nodeType !== Node.ELEMENT_NODE) return null;
        const tag = node.tagName.toLowerCase();
        if (!allowed.has(tag)) return document.createTextNode(node.textContent || "");
        const el = document.createElement(tag);
        (attrAllow[tag] || []).forEach((attr) => {
          const val = node.getAttribute(attr);
          if (!val) return;
          if (attr === "href" || attr === "src") {
            const safe = safeUrl(val);
            if (!safe) return;
            el.setAttribute(attr, safe);
          } else {
            el.setAttribute(attr, val);
          }
        });
        if (tag === "a" && el.getAttribute("href")) {
          el.setAttribute("rel", "noopener noreferrer");
          el.setAttribute("target", "_blank");
        }
        node.childNodes.forEach((child) => {
          const cleaned = clean(child);
          if (cleaned) el.appendChild(cleaned);
        });
        return el;
      };
      const container = document.createElement("div");
      doc.body.childNodes.forEach((child) => {
        const cleaned = clean(child);
        if (cleaned) container.appendChild(cleaned);
      });
      return container.innerHTML;
    };

    const renderItems = (items) => {
      itemsList.innerHTML = (items || []).map((item) => {
        const title = esc(item.title || "(untitled)");
        const safeLink = esc(item.link || "");
        const link = item.link ? `<a href="${safeLink}" target="_blank" rel="noopener noreferrer">${title}</a>` : title;
        const thumbUrl = safeUrl(item.thumbnail || "");
        const thumb = thumbUrl ? `<div class="thumb-wrap"><img class="thumb" src="${esc(thumbUrl)}" alt="" loading="lazy" /></div>` : "";
        const metaBits = [item.feed, formatTime(item.published)].map(esc).filter(Boolean);
        const meta = metaBits.length ? `<div class="meta">${metaBits.join(" Â· ")}</div>` : "";
        const summary = item.summary ? `<div class="summary">${sanitizeSummary(item.summary)}</div>` : "";
        const viewed = Boolean(item.viewed);
        const mark = item.id
          ? `<div class="item-actions">
              <button class="mark-toggle ${viewed ? "viewed" : ""}" data-id="${esc(item.id)}" data-viewed="${viewed ? "true" : "false"}" title="Toggle viewed">
                ${viewed ? viewedIcon : unviewedIcon}
              </button>
             </div>`
          : "";
        const liClass = viewed ? "viewed" : "";
        return `<li class="${liClass}">
          <div class="item-head">
            ${thumb}
            <div class="item-main">
              <div class="item-title">${link}</div>
              ${meta}
            </div>
            ${mark}
          </div>
          ${summary}
        </li>`;
      }).join("");
    };

    const setStatus = (text, isError = false) => {
      statusBox.textContent = text || "";
      statusBox.style.color = isError ? "#fca5a5" : "#a5f3fc";
    };

    const fetchFeeds = () =>
      fetch("/api/feeds")
        .then((r) => r.json())
        .then((data) => renderFeeds(data.feeds || []))
        .catch(() => setStatus("Failed to load feeds", true));

    const fetchItems = () => {
      const n = parseInt(itemLimitInput.value, 10);
      const limit = Number.isFinite(n) ? n : 30;
      const params = [];
      params.push(limit > 0 ? `limit=${limit}` : "limit=0");
      if (limit > 0) params.push(`page=${currentPage}`);
      if (showViewedInput.checked) params.push("include_viewed=1");
      const qs = params.length ? `?${params.join("&")}` : "";
      return fetch(`/api/items${qs}`)
        .then((r) => r.json())
        .then((data) => {
          totalItems = data.total || (data.items || []).length;
          const pageFromServer = data.page || 1;
          const maxPage = limit > 0 ? Math.max(1, Math.ceil((totalItems || 0) / limit)) : 1;
          if (pageFromServer > maxPage) {
            currentPage = maxPage;
            return fetchItems();
          }
          currentPage = pageFromServer;
          renderItems(data.items || []);
          updatePager(maxPage);
        })
        .catch(() => setStatus("Failed to load items", true));
    };

    document.getElementById("feed-form").addEventListener("submit", (ev) => {
      ev.preventDefault();
      const url = urlInput.value.trim();
      if (!url) return;
      setStatus("Adding feed...");
      fetch("/api/feeds", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url }),
      })
        .then((r) => r.json().then((data) => ({ status: r.status, data })))
        .then(({ status, data }) => {
          if (status >= 400) throw new Error(data.error || "Failed");
          renderFeeds(data.feeds || []);
          setStatus(data.message || "Added");
          urlInput.value = "";
          fetchItems();
        })
        .catch((err) => setStatus(err.message || "Failed to add feed", true));
    });

    importOpmlBtn.addEventListener("click", () => {
      const file = (opmlInput.files || [])[0];
      if (!file) {
        setStatus("Choose an OPML file first", true);
        return;
      }
      const form = new FormData();
      form.append("file", file);
      setStatus("Importing OPML...");
      fetch("/api/feeds/import", { method: "POST", body: form })
        .then((r) => r.json().then((data) => ({ status: r.status, data })))
        .then(({ status, data }) => {
          if (status >= 400) throw new Error(data.error || "Failed");
          renderFeeds(data.feeds || []);
          setStatus(data.message || "Imported");
          fetchItems();
        })
        .catch((err) => setStatus(err.message || "Failed to import", true));
    });

    exportOpmlBtn.addEventListener("click", () => {
      setStatus("Exporting OPML...");
      fetch("/api/feeds/export")
        .then((r) => {
          if (!r.ok) throw new Error("Failed");
          return r.blob();
        })
        .then((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "feeds.opml";
          a.click();
          URL.revokeObjectURL(url);
          setStatus("Exported");
        })
        .catch((err) => setStatus(err.message || "Failed to export", true));
    });

    refreshBtn.addEventListener("click", () => {
      setStatus("Refreshing feeds...");
      refreshBtn.disabled = true;
      fetch("/api/feeds/refresh", { method: "POST" })
        .then((r) => r.json().then((data) => ({ status: r.status, data })))
        .then(({ status, data }) => {
          if (status >= 400) throw new Error(data.error || "Failed");
          renderFeeds(data.feeds || []);
          setStatus(data.message || "Refreshed");
          currentPage = 1;
          return fetchItems();
        })
        .catch((err) => setStatus(err.message || "Failed to refresh", true))
        .finally(() => {
          refreshBtn.disabled = false;
        });
    });

    feedList.addEventListener("click", (ev) => {
      const btn = ev.target.closest("button.delete");
      if (!btn) return;
      const url = btn.dataset.url;
      setStatus("Removing feed...");
      fetch("/api/feeds", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url }),
      })
        .then((r) => r.json().then((data) => ({ status: r.status, data })))
        .then(({ status, data }) => {
          if (status >= 400) throw new Error(data.error || "Failed");
          renderFeeds(data.feeds || []);
          setStatus(data.message || "Removed");
          fetchItems();
        })
        .catch((err) => setStatus(err.message || "Failed to remove feed", true));
    });

    itemLimitInput.addEventListener("change", () => {
      currentPage = 1;
      fetchItems();
    });
    showViewedInput.addEventListener("change", () => {
      currentPage = 1;
      fetchItems();
    });
    prevPageBtns.forEach((btn) =>
      btn.addEventListener("click", () => {
        if (currentPage <= 1) return;
        currentPage -= 1;
        fetchItems();
      })
    );
    nextPageBtns.forEach((btn) =>
      btn.addEventListener("click", () => {
        const n = parseInt(itemLimitInput.value, 10);
        if (!(Number.isFinite(n) && n > 0)) return;
        const maxPage = Math.max(1, Math.ceil((totalItems || 0) / n));
        if (currentPage >= maxPage) return;
        currentPage += 1;
        fetchItems();
      })
    );

    itemsList.addEventListener("click", (ev) => {
      const btn = ev.target.closest("button.mark-toggle");
      if (!btn) return;
      const id = btn.dataset.id;
      if (!id) return;
      const nextViewed = btn.dataset.viewed === "true" ? false : true;
      btn.disabled = true;
      setStatus(nextViewed ? "Marking viewed..." : "Unmarking...");
      fetch("/api/items/viewed", {
        method: nextViewed ? "POST" : "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id }),
      })
        .then((r) => r.json().then((data) => ({ status: r.status, data })))
        .then(({ status, data }) => {
          if (status >= 400) throw new Error(data.error || "Failed");
          setStatus(data.message || (nextViewed ? "Marked" : "Unmarked"));
          fetchItems();
        })
        .catch((err) => {
          btn.disabled = false;
          setStatus(err.message || "Failed to update", true);
        });
    });

    const updatePager = (maxPage) => {
      const n = parseInt(itemLimitInput.value, 10);
      const limit = Number.isFinite(n) ? n : 30;
      const disablePaging = !Number.isFinite(limit) || limit <= 0 || totalItems <= limit;
      pagers.forEach((p) => {
        p.style.display = disablePaging ? "none" : "flex";
      });
      if (disablePaging) return;
      pageInfos.forEach((info) => {
        info.textContent = `Page ${currentPage} of ${maxPage}`;
      });
      prevPageBtns.forEach((btn) => {
        btn.disabled = currentPage <= 1;
      });
      nextPageBtns.forEach((btn) => {
        btn.disabled = currentPage >= maxPage;
      });
    };

    fetchFeeds().then(fetchItems).catch(fetchItems);
  </script>
</body>
</html>
